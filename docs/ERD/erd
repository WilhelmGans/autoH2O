// Car Wash Database Schema for dbdiagram.io

Table users {
  id uuid [primary key]
  phone_number varchar(20) [not null, unique]
  role varchar(20) [not null] // client, washer, cashier, accountant, director
  first_name varchar(100)
  last_name varchar(100)
  email varchar(255)
  rating decimal(3,2) [default: 5.0]
  cancelation_count integer [default: 0]
  is_blocked boolean [default: false]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]

  indexes {
    phone_number
    role
    is_blocked
  }
}

Table users_cars {
  user_id uuid [ref: > users.id]
  car_id uuid [ref: > cars.id]

  indexes {
      user_id
      car_id
  }
}

Table cities {
  id int [primary key]
  name varchar(255) [not null]
}

Table addresses {
  id int [primary key]
  city_id int [ref: > cities.id]
  street varchar(255)
  house_number  varchar(255)
  building varchar(255)
}

Table car_washes {
  id uuid [primary key]
  name varchar(255) [not null]
  address_id int [ref: - addresses.id]
  open_time time [not null]
  close_time time [not null]
  city varchar(100) [not null]
  created_at timestamp [default: `now()`]
}

Table boxes {
  id uuid [primary key]
  car_wash_id uuid [not null, ref: > car_washes.id]
  number integer [not null]
  type varchar(20) [not null] // online, queue
  is_active boolean [default: true]

  indexes {
    car_wash_id
    (car_wash_id, number) [unique]
  }
}

Table services {
  id uuid [primary key]
  name varchar(255) [not null]
  description text
  base_price decimal(10,2) [not null]
  category varchar(20) [not null] // base, additional, special
  duration_minutes integer [not null]
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
}

Table cars {
  id uuid [primary key]
  vin varchar(17) [unique]
  make varchar(100) [not null]
  model varchar(100) [not null]
  multiplier decimal [default: 1] // sedan 1, jeep 1.5, bus 2
  year integer [not null]
  gos_number varchar(20) [not null]
  body_type varchar(50) [not null] // car, jeep, suv
  color varchar(50)
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]

  indexes {
    gos_number
  }
}

Table orders {
  id uuid [primary key]
  user_id uuid [not null, ref: > users.id]
  car_id uuid [not null, ref: > cars.id]
  car_wash_id uuid [not null, ref: > car_washes.id]
  box_id uuid [not null, ref: > boxes.id]
  status varchar(20) [not null] // created, paid, in_progress, completed, cancelled
  payment_method varchar(20) [not null] // online, cash
  payment_status varchar(20) [not null] // pending, paid, failed, refunded

  total_amount decimal(10,2) [not null]
  final_amount decimal(10,2) [not null]
  discount_amount decimal(10,2) [default: 0]
  bonus_points_used integer [default: 0]

  scheduled_time timestamp [not null]
  start_time timestamp
  end_time timestamp

  washer_id uuid [ref: > users.id]

  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]

  indexes {
    user_id
    status
    scheduled_time
    car_wash_id
    washer_id
  }
}

Table order_services {
  id uuid [primary key]
  order_id uuid [not null, ref: > orders.id]
  service_id uuid [not null, ref: > services.id]
  vehicle_type varchar(20) [not null] // car, jeep
  quantity integer [default: 1]
  unit_price decimal(10,2) [not null]
  total_price decimal(10,2) [not null]
  created_at timestamp [default: `now()`]

  indexes {
    order_id
    service_id
  }
}

//Таблица promotions предназначена для управления промоакциями и системами скидок в приложении автомойки.
//INSERT INTO promotions (name, discount_type, discount_value, valid_from, valid_until)
//  VALUES ('Зимняя акция', 'percentage', 20.00, '2024-12-01', '2025-02-28');
Table promotions {
  id uuid [primary key]
  name varchar(255) [not null]
  description text
  code varchar(50) [unique]
  discount_type varchar(20) [not null] // percentage, fixed, special
  discount_value decimal(10,2) [not null]
  min_order_amount decimal(10,2) [default: 0]
  max_discount decimal(10,2)
  valid_from timestamp [not null]
  valid_until timestamp [not null]
  usage_limit integer
  used_count integer [default: 0]
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]

  indexes {
    code
    is_active
    valid_until
  }
}

Table order_promotions {
  id uuid [primary key]
  order_id uuid [not null, ref: > orders.id]
  promotion_id uuid [not null, ref: > promotions.id]
  discount_amount decimal(10,2) [not null]
  created_at timestamp [default: `now()`]

  indexes {
    order_id
    promotion_id
  }
}

Table bonuses {
  id uuid [primary key]
  user_id uuid [not null, ref: > users.id]
  order_id uuid [ref: > orders.id]
  type varchar(20) [not null] // earned, spent, expired
  points integer [not null]
  balance_after integer [not null]
  description text
  created_at timestamp [default: `now()`]

  indexes {
    user_id
    order_id
    created_at
  }
}

Table reviews {
  id uuid [primary key]
  order_id uuid [not null, ref: > orders.id, unique]
  user_id uuid [not null, ref: > users.id]
  rating integer [not null] // 1-5
  comment text
  washer_rating integer // 1-5
  created_at timestamp [default: `now()`]

  indexes {
    order_id
    user_id
    rating
  }
}

Table review_photos {
  id uuid [primary key]
  review_id uuid [not null, ref: > reviews.id]
  photo_url text [not null]
  created_at timestamp [default: `now()`]

  indexes {
    review_id
  }
}

Table special_tariffs {
  id uuid [primary key]
  name varchar(255) [not null]
  description text
  user_category varchar(50) [not null] // taxi, vip, corporate
  discount_percentage decimal(5,2) [not null]
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
}

Table user_special_tariffs {
  id uuid [primary key]
  user_id uuid [not null, ref: > users.id]
  tariff_id uuid [not null, ref: > special_tariffs.id]
  assigned_at timestamp [default: `now()`]
  assigned_by uuid [ref: > users.id]

  indexes {
    user_id
    tariff_id
  }
}

Table time_slots {
  id uuid [primary key]
  box_id uuid [not null, ref: > boxes.id]
  slot_time timestamp [not null]
  is_available boolean [default: true]
  order_id uuid [ref: > orders.id]

  indexes {
    (box_id, slot_time) [unique]
    box_id
    slot_time
    is_available
  }
}

Table notifications {
  id uuid [primary key]
  user_id uuid [not null, ref: > users.id]
  title varchar(255) [not null]
  message text [not null]
  type varchar(50) [not null]
  is_read boolean [default: false]
  related_entity_type varchar(50)
  related_entity_id uuid
  created_at timestamp [default: `now()`]

  indexes {
    user_id
    is_read
    created_at
  }
}

Table integration_logs {
  id uuid [primary key]
  entity_type varchar(50) [not null]
  entity_id uuid [not null]
  operation varchar(50) [not null]
  status varchar(20) [not null] // pending, success, error
  request_data jsonb
  response_data jsonb
  error_message text
  created_at timestamp [default: `now()`]

  indexes {
    (entity_type, entity_id)
    status
    created_at
  }
}

